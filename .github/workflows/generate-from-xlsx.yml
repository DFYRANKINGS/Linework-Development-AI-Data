name: Generate JSON/YAML from XLSX and Update Sitemap

on:
  push:
    branches:
      - main  # or 'master', adjust as needed
    paths:
      - 'templates/*.xlsx'

jobs:
  generate-and-update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN }}  # üëà Use your token for push access
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: |
          pip install pandas openpyxl PyYAML

      - name: Get Changed XLSX Files
        id: get_files
        env:
          PAYLOAD: ${{ toJson(github.event) }}
        run: |
          echo "üìÑ Parsing push event for changed files..."
          ADDED_MODIFIED=$(echo "$PAYLOAD" | jq -r '.commits[].added[], .commits[].modified[]' | grep '^templates/.*\.xlsx$' | sort -u || true)
          if [ -z "$ADDED_MODIFIED" ]; then
            echo "‚ö†Ô∏è No .xlsx files found in templates/"
          else
            echo "‚úÖ Detected XLSX files:"
            echo "$ADDED_MODIFIED"
          fi
          echo "changed_xlsx=$ADDED_MODIFIED" >> $GITHUB_ENV

      - name: Process Each XLSX File
        if: env.changed_xlsx != ''
        run: |
          echo "‚öôÔ∏è Processing detected XLSX files..."
          while IFS= read -r xlsx_file; do
            if [ -n "$xlsx_file" ] && [ -f "$xlsx_file" ]; then
              echo "üìÑ Processing: $xlsx_file"
              python ai-generators/generate_files_from_xlsx.py --input "$xlsx_file"
            else
              echo "‚ö†Ô∏è Skipped (file not found or empty): '$xlsx_file'"
            fi
          done <<< "${{ env.changed_xlsx }}"

      - name: Generate or Update Sitemap
        run: |
          python generate_sitemaps.py

      - name: Configure Git & Attach to Branch
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          # Ensure we're on the correct branch (not detached HEAD)
          git switch --detach ${{ github.ref_name }}

      - name: Commit and Push Changes
        run: |
          git add .
          git status
          # Only commit if there are changes
          if ! git diff --cached --quiet; then
            git commit -m "ü§ñ Auto-generate files from XLSX and update sitemap"
            echo "‚úÖ Changes committed."
            # Push to current branch
            git push origin ${{ github.ref_name }}
            echo "‚úÖ Changes pushed."
          else
            echo "‚è≠Ô∏è No file changes detected. Nothing to commit or push."
          fi
